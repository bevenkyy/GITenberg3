#!/usr/bin/env bash
#
# fff - fucking fast file-manager.

refresh() {
    printf '\e[?7l\e[?25l\e[2J\e[H'
    shopt -s checkwinsize; (:;:)
    [[ -z "${LINES:-$COLUMNS}" ]] && read -r LINES COLUMNS < <(stty size)
    ((j=LINES-3))
}

get_dir() {
    d=(); f=()
    for p in "$PWD"/*; do
        [[ -d "$p" ]] && d+=("$p")
        [[ -f "$p" ]] && f+=("$p")
    done
    f=("${d[@]}" "${f[@]}"); c="${#f[@]}"
}

f_print() {
    for((i=${k:=0};i<(j=j>c?c:j);i++));{
        path="${f[$i]##*/}"
        [[ -d "${f[$i]}" ]] && path="\\e[1m\\e[31m${path}/\\e[m"
        [[ "${f[$i]}" == "${f[l]}" ]] && path="\\e[7m${path}\\e[m"
        printf '\e[K%b\n' "$path"
    }

    printf '\e[2m\e[%s;H\e[K\n\e[K%b\e[m\e[H' \
           "$((LINES-2))" "${PWD/\/\//\/} (${l:-1}/$((c-1)))"
}

open() {
    if [[ -d "${1:-/}" ]]; then
        ((k=0,l=0))
        refresh
        PWD="${1:-/}"
        get_dir
        f_print
    elif [[ -f "$1" ]]; then
        case "${1##*.}" in
            # TODO: Expand on this properly.
            pdf|gif|jpg|jpeg|svg|png|mkv|mp4|zip|gz|7z|bin|flv)
               nohup xdg-open "$1" >/dev/null 2>&1 &
            ;;

            *) "${EDITOR:-vi}" "$1"; printf '\e[?25l' ;;
        esac
    fi
}

key() {
    case "${1: -1}" in
        j) ((l==c-1))||((l++));((j==c))||((k=k>=j?k:++k,j=j<c?++j:j)) ;;
        k) ((l==0))||((l--));((k==0))||((k=k<=j?k>0?--k:0:j,j=j>0?--j:j)) ;;
        l) open "${f[l]}" ;;
        h) open "${PWD%/*}" ;;
        g) ((l=0,k=0)); refresh ;;
        G) ((k=c-j,j=c,l=c-1)); f_print ;;
    esac
}

main() {
    refresh
    get_dir; f_print
    shopt -s nullglob extglob

    trap $'printf \'\e[?25h\e[?7h\e[999B\';shopt -u nullglob extglob' EXIT
    trap  'refresh; k=0; l=0; f_print' SIGWINCH

    for ((;;)); { f_print; read -rs -n 1; key "$REPLY"; }
}

main "$@"
